name: Convert and Update Markdown

on:
  push:
    branches: [ main ]

jobs:
  convert-and-update:
    runs-on: ubuntu-latest
    steps:
      # Checkout main branch (source files)
      - uses: actions/checkout@v4
        with:
          path: 'source'
          ref: main

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Install dependencies
      - name: Install dependencies
        run: |
          pip install jupyter jupytext nbconvert

      # Convert files to markdown
      - name: Convert to Markdown
        run: |
          cd source
          find . -name '*.ipynb' -exec jupyter nbconvert --to markdown --no-execute {} \;
          find . -name '*.py' ! -name 'config.json' -exec bash -c '
            echo "\`\`\`python" > "{}.md"
            cat "{}" >> "{}.md"
            echo "\`\`\`" >> "{}.md"
          ' \;

      # Checkout markdown branch and update files
      - name: Update markdown branch
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Checkout markdown branch in a separate directory
          git clone --branch markdown --single-branch https://github.com/brett-van-tussler/code-examples.git markdown || \
            git clone https://github.com/brett-van-tussler/code-examples.git markdown && \
            (cd markdown && git checkout --orphan markdown)
          
          # Copy only markdown files and config.json
          find source -name '*.md' -exec cp --parents {} markdown \;
          cp source/config.json markdown/
          
          # Commit changes
          cd markdown
          git add .
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
          else
            git commit -m "Update markdown files [auto]"
            git push origin markdown
          fi